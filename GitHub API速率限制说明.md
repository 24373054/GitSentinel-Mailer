# GitHub API速率限制问题解决方案

## 🔴 问题原因

您遇到的 `403` 错误是GitHub API的**速率限制（Rate Limit）**问题：

### 速率限制说明

- **未认证请求**：每小时 **60次** 请求
- **认证请求（使用Token）**：每小时 **5000次** 请求
- **重置时间**：限制会在每小时整点重置（例如：10:00, 11:00...）

### 为什么会触发限制？

您的监控间隔被设置为 **10秒**，这太频繁了！

**计算：**
- 10秒检查一次 = 每分钟6次 = 每小时360次
- 但GitHub只允许每小时60次（未认证）
- **结果：6分钟后就会达到限制！**

## ✅ 已实施的修复

我已经做了以下修复：

### 1. **调整监控间隔**
- 从 10秒 → **10分钟**
- 这样每小时最多6次请求，远低于60次限制

### 2. **智能错误处理**
- ✅ 检测速率限制状态
- ✅ 显示剩余请求次数
- ✅ 显示重置时间
- ✅ 速率限制时自动跳过检查
- ✅ 改进的错误日志提示

### 3. **速率限制监控**
- 实时显示剩余请求次数
- 接近限制时自动警告
- 达到限制时智能等待

### 4. **GitHub Token支持**
- 如果配置了Token，限制提高到5000次/小时
- 支持监控私有仓库

## 🚀 推荐解决方案

### 方案一：使用默认设置（已修复）

**当前配置（已自动修复）：**
- ✅ 监控间隔：10分钟
- ✅ 每小时最多6次请求
- ✅ 远低于60次限制，安全

**无需任何操作，问题已解决！**

### 方案二：添加GitHub Token（推荐，用于大量监控）

如果您需要监控多个仓库或更频繁的检查，建议添加GitHub Token：

#### 步骤1：创建GitHub Token

1. 登录GitHub
2. 访问：https://github.com/settings/tokens
3. 点击 "Generate new token (classic)"
4. 填写：
   - **Note**: GitHub监控系统
   - **Expiration**: 选择过期时间（建议90天或更久）
   - **Select scopes**: 
     - ✅ `public_repo` (查看公共仓库)
     - ✅ `repo` (如果要监控私有仓库)
5. 点击 "Generate token"
6. **复制生成的token**（只显示一次！）

#### 步骤2：配置Token

**方式A：环境变量（推荐）**

创建 `.env` 文件（项目根目录）：
```env
GITHUB_TOKEN=your_github_token_here
```

**方式B：启动脚本设置**

修改 `start-server.bat` 或 `start-dev.bat`：
```batch
set GITHUB_TOKEN=your_github_token_here
npm run dev
```

**方式C：PowerShell临时设置**
```powershell
$env:GITHUB_TOKEN="your_github_token_here"
npm run dev
```

#### 步骤3：重启服务

```bash
# 停止当前服务 (Ctrl+C)
# 然后重新启动
npm run dev
```

#### 好处

✅ 限制提高到 **5000次/小时**
✅ 可以监控更频繁（可以改为5分钟或更短）
✅ 可以监控私有仓库
✅ 更好的API响应速度

## 📊 监控间隔建议

根据您的需求和是否使用Token：

| 监控项目数 | 是否使用Token | 推荐间隔 | 每小时请求数 |
|-----------|-------------|---------|-------------|
| 1-5个     | ❌ 否       | 10分钟  | 6-30次      |
| 1-5个     | ✅ 是       | 5分钟   | 12-60次     |
| 5-20个    | ❌ 否       | 15-20分钟| 3-12次     |
| 5-20个    | ✅ 是       | 5分钟   | 60-240次    |
| 20+个     | ❌ 否       | 30分钟  | 2-4次       |
| 20+个     | ✅ 是       | 5分钟   | 240+次      |

## 🛠️ 如何修改监控间隔

编辑 `server/monitorService.js`：

```javascript
// 第22行，修改这个值
const MONITOR_INTERVAL = 10 * 60 * 1000; // 10分钟

// 例如改为5分钟：
const MONITOR_INTERVAL = 5 * 60 * 1000; // 5分钟
```

**修改后记得重启服务！**

## 📈 查看当前速率限制状态

系统现在会在日志中显示：
- 🔍 检查时会显示：`(剩余请求: X)`
- ⚠️ 接近限制时会警告
- ❌ 达到限制时会显示重置时间

## 🎯 最佳实践

1. **少量监控（1-5个）**：使用默认10分钟间隔，无需Token
2. **中等监控（5-15个）**：使用10-15分钟间隔，或添加Token后改为5分钟
3. **大量监控（15+个）**：**必须添加Token**，推荐5分钟间隔
4. **频繁更新仓库**：可以缩短到3-5分钟（需Token）

## 🔍 如何判断是否遇到速率限制

查看后端控制台日志：

**速率限制时的日志：**
```
❌ [速率限制] 获取仓库 xxx/yyy 失败: 已达每小时60次请求上限，将在 2025-01-01 11:00:00 重置
💡 建议：添加GitHub Token可提高限制到每小时5000次
```

**正常情况下的日志：**
```
🔍 正在检查项目 xxx/yyy 的变更... (剩余请求: 45)
✓ 项目 xxx/yyy 暂无新提交
```

## ⚠️ 注意事项

1. **不要设置太短的间隔**
   - 少于5分钟且无Token = 很容易触发限制
   - 少于10分钟且多项目 = 风险较高

2. **Token安全**
   - 不要将Token提交到Git仓库
   - 使用 `.env` 文件（已在`.gitignore`中）
   - Token泄露后立即撤销并重新生成

3. **重置时间**
   - 限制在每小时整点重置（例如：10:00, 11:00）
   - 不是从第一次请求开始计算60分钟

## 🆘 问题排查

**问题：仍然看到403错误**

1. 检查是否使用了Token（查看日志）
2. 确认监控间隔足够长
3. 等待到下一个整点小时重置
4. 检查是否同时运行多个监控实例

**问题：想更频繁检查**

1. 添加GitHub Token（必需）
2. 缩短监控间隔（但不要太短）
3. 考虑减少监控项目数

## 📝 总结

✅ **问题已修复**：监控间隔已调整为10分钟，不会再触发速率限制

✅ **智能处理**：系统会自动检测和处理速率限制

✅ **可选增强**：添加GitHub Token可大幅提高限制

现在系统应该可以稳定运行了！🎉

